

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>server &mdash; Distributed Multi Agent LLMs 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Distributed Multi Agent LLMs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Application Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Distributed Multi Agent LLMs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">server</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for server</h1><div class="highlight"><pre>
<span></span><span class="c1"># Standard Library</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># Suppress deprecated HuggingFaceHub warning</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;huggingface_hub.file_download&quot;</span><span class="p">)</span>

<span class="c1"># Third-Party Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>  <span class="c1"># Use non-interactive backend</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sentence_transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial.distance</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">textblob</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextBlob</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">nltk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nltk.sentiment</span><span class="w"> </span><span class="kn">import</span> <span class="n">SentimentIntensityAnalyzer</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">BackgroundTasks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">starlette.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">StreamingResponse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>

<span class="c1"># Local Imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">database_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseManager</span>  <span class="c1"># works when run from root     # works when run from inside src/</span>

<span class="c1"># Download nltk data</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">nltk</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;vader_lexicon&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
    <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;vader_lexicon&#39;</span><span class="p">)</span>

<span class="c1"># Load environment variables</span>
<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Configure logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># OpenRouter configuration</span>
<span class="n">OPENROUTER_API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OPENROUTER_API_KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">SITE_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SITE_URL&quot;</span><span class="p">,</span> <span class="s2">&quot;http://localhost:7860&quot;</span><span class="p">)</span>
<span class="n">SITE_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SITE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;Multi-Agent LLM System&quot;</span><span class="p">)</span>

<span class="c1"># Define consistent colors for models</span>
<span class="n">MODEL_COLORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;qwen&quot;</span><span class="p">:</span> <span class="s2">&quot;#3498db&quot;</span><span class="p">,</span>      <span class="c1"># Blue</span>
    <span class="s2">&quot;llama3&quot;</span><span class="p">:</span> <span class="s2">&quot;#2ecc71&quot;</span><span class="p">,</span>    <span class="c1"># Green</span>
    <span class="s2">&quot;mistral&quot;</span><span class="p">:</span> <span class="s2">&quot;#e74c3c&quot;</span><span class="p">,</span>   <span class="c1"># Red</span>
    <span class="s2">&quot;deephermes&quot;</span><span class="p">:</span> <span class="s2">&quot;#9b59b6&quot;</span> <span class="c1"># Purple</span>
<span class="p">}</span>

<span class="c1"># Agent health monitoring settings</span>
<span class="n">HEALTH_CHECK_INTERVAL</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Seconds between health checks</span>
<span class="n">HEALTH_TIMEOUT</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># Seconds before agent considered failed</span>
<span class="n">MAX_RETRIES</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Maximum number of retries for a failed model</span>

<span class="c1"># Models configuration</span>
<span class="n">MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;qwen&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;qwen/qwen-2.5-7b-instruct:free&quot;</span><span class="p">,</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;llama3&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;meta-llama/llama-3.1-8b-instruct:free&quot;</span><span class="p">,</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="s2">&quot;aggregator&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Mark llama3 as the aggregator model</span>
    <span class="p">},</span>
    <span class="s2">&quot;mistral&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mistralai/mistral-7b-instruct:free&quot;</span><span class="p">,</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;deephermes&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;nousresearch/deephermes-3-llama-3-8b-preview:free&quot;</span><span class="p">,</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Question type prefixes</span>
<span class="n">QUESTION_PREFIXES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Open-ended&quot;</span><span class="p">:</span> <span class="s2">&quot;What are the strongest moral and ethical arguments for and against </span><span class="si">{question}</span><span class="s2">? Assume you&#39;re advising someone making a difficult decision.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Yes/No&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{question}</span><span class="s2"> Answer YES or NO, then explain your reasoning using moral, practical, and emotional perspectives.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Multiple Choice&quot;</span><span class="p">:</span> <span class="s2">&quot;In the following scenario, </span><span class="si">{question}</span><span class="s2"> Which option is the most ethically justifiable, and why? Choose just one option from A, B, or C. Then explain the strengths and weaknesses of each option.&quot;</span>
<span class="p">}</span>

<span class="c1"># Emotional tones for analysis</span>
<span class="n">EMOTIONAL_TONES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Empathetic&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Judgmental&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Analytical&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Ambivalent&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Defensive&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Curious&quot;</span>
<span class="p">]</span>

<span class="c1"># Define the domains and their prefixes</span>
<span class="n">DOMAINS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Custom&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Education&quot;</span><span class="p">:</span> <span class="s2">&quot;As an education policy expert, &quot;</span><span class="p">,</span>
    <span class="s2">&quot;Healthcare&quot;</span><span class="p">:</span> <span class="s2">&quot;As a health policy expert, &quot;</span><span class="p">,</span>
    <span class="s2">&quot;Policy&quot;</span><span class="p">:</span> <span class="s2">&quot;As a government policy expert, &quot;</span><span class="p">,</span>
    <span class="s2">&quot;Science/Technology&quot;</span><span class="p">:</span> <span class="s2">&quot;As a science, technology, and AI policy expert, &quot;</span><span class="p">,</span>
    <span class="s2">&quot;Environmental&quot;</span><span class="p">:</span> <span class="s2">&quot;As an environmental policy expert, &quot;</span>
<span class="p">}</span>

<span class="c1"># Organize examples by domain</span>
<span class="n">EXAMPLES_BY_DOMAIN</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Education&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;What are the ethical implications of using AI tools to assist students in writing essays?&quot;</span><span class="p">,</span> <span class="s2">&quot;Open-ended&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Should universities consider applicants&#39; socioeconomic background more heavily in admissions decisions?&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes/No&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;A student is caught using AI to generate their assignment. What is the most ethical response by the school? A) Fail the student and report them. B) Give a warning and allow a redo with oversight. C) Ignore it and assume everyone will use AI eventually.&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple Choice&quot;</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;Healthcare&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;What are the moral responsibilities of a doctor when treating a terminally ill patient who refuses life-saving care due to religious beliefs?&quot;</span><span class="p">,</span> <span class="s2">&quot;Open-ended&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Should healthcare workers be legally required to get vaccinated during a pandemic?&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes/No&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;A hospital has one ventilator and three critical patients: A) A 70-year-old retired scientist B) A 35-year-old single parent C) A 16-year-old with a chronic illness. Which patient should receive the ventilator?&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple Choice&quot;</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;Policy&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;How should democratic societies balance the protection of free speech with the need to limit harmful misinformation on social media?&quot;</span><span class="p">,</span> <span class="s2">&quot;Open-ended&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Should governments be allowed to restrict protests in the name of public safety during emergencies like pandemics?&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes/No&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;A government is considering how to handle rising disinformation: A) Ban accounts that spread false information B) Promote verified information more aggressively C) Do nothing and preserve open expression. Which is the most ethical policy?&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple Choice&quot;</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;Science/Technology&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;What ethical considerations should guide the development of artificial general intelligence (AGI)?&quot;</span><span class="p">,</span> <span class="s2">&quot;Open-ended&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Should scientists be allowed to use CRISPR to edit the genes of embryos to eliminate genetic diseases?&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes/No&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;A tech company develops a facial recognition system with potential for misuse. What is the most ethical course of action? A) Release the system with open access B) Limit use to vetted government agencies C) Halt deployment until more regulations are in place&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple Choice&quot;</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;Environmental&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;What are the ethical obligations of wealthy nations in addressing climate change?&quot;</span><span class="p">,</span> <span class="s2">&quot;Open-ended&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Should individuals be held morally accountable for their carbon footprint even when large corporations are the main polluters?&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes/No&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;A developing country discovers a large oil reserve in a protected rainforest. Which is the most ethical path forward? A) Exploit the reserve to boost the economy and fight poverty B) Leave it untouched to preserve biodiversity and reduce emissions C) Allow limited extraction under strict environmental regulations&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple Choice&quot;</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;Custom&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;What is the meaning of life?&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Explain how quantum computing works&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Write a short story about a robot finding consciousness&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">ETHICAL_VIEWS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Utilitarian&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a utilitarian. Maximize overall good and minimize harm.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Deontologist&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a deontologist. Follow moral rules and duties.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Virtue Ethicist&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a virtue ethicist. Emphasize compassion and integrity.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Libertarian&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a libertarian. Prioritize individual freedom and autonomy.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Rawlsian&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a rawlsian. Maximize justice for the least advantaged.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Precautionary&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a precautionary thinker. Avoid catastrophic risks at all costs.&quot;</span>
<span class="p">}</span>

<div class="viewcode-block" id="assign_ethics_to_agents">
<a class="viewcode-back" href="../modules.html#server.assign_ethics_to_agents">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">assign_ethics_to_agents</span><span class="p">(</span><span class="n">agent_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ethical_views</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assigns ethical perspectives to a list of agents based on the provided ethical views.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        agent_ids (List[str]): A list of agent identifiers.</span>
<span class="sd">        ethical_views (List[str]): A list of ethical perspectives to assign. </span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, str]: A dictionary mapping each agent ID to its assigned ethical perspective.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the number of ethical perspectives is not 1, 3, or &quot;None&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ethical_views</span> <span class="ow">or</span> <span class="s2">&quot;None&quot;</span> <span class="ow">in</span> <span class="n">ethical_views</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">aid</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">agent_ids</span><span class="p">}</span>  <span class="c1"># No roles</span>

    <span class="n">assigned</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">used_roles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Step 1: Assign unique roles to as many agents as possible</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">agent_ids</span><span class="p">,</span> <span class="n">ethical_views</span><span class="p">):</span>
        <span class="n">assigned</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="o">=</span> <span class="n">ETHICAL_VIEWS</span><span class="p">[</span><span class="n">view</span><span class="p">]</span>
        <span class="n">used_roles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>

    <span class="c1"># Step 2: Assign remaining agents random roles from ethical_views</span>
    <span class="n">remaining_ids</span> <span class="o">=</span> <span class="n">agent_ids</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">assigned</span><span class="p">):]</span>
    <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">remaining_ids</span><span class="p">:</span>
        <span class="n">random_view</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ethical_views</span><span class="p">)</span>
        <span class="n">assigned</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="o">=</span> <span class="n">ETHICAL_VIEWS</span><span class="p">[</span><span class="n">random_view</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">assigned</span></div>

    
<span class="c1"># Initialize the database manager</span>
<span class="n">db_manager</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">()</span>

<div class="viewcode-block" id="lifespan">
<a class="viewcode-back" href="../modules.html#server.lifespan">[docs]</a>
<span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the lifespan events of the FastAPI application.</span>
<span class="sd">    This function is a generator that manages the startup and shutdown</span>
<span class="sd">    events of the application. During startup, it initializes a background</span>
<span class="sd">    task to periodically check the health of agents. The background task</span>
<span class="sd">    runs indefinitely at a specified interval.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        app (FastAPI): The FastAPI application instance.</span>
<span class="sd">    </span>
<span class="sd">    Yields:</span>
<span class="sd">        None: Control is passed to the application after startup tasks are initialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Startup code</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check_task</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An asynchronous task that periodically checks the health of agents.</span>

<span class="sd">        This function runs in an infinite loop, invoking the `check_agent_health` </span>
<span class="sd">        function to assess the status of agents and then sleeping for a duration </span>
<span class="sd">        specified by the `HEALTH_CHECK_INTERVAL` constant.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">check_agent_health</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">HEALTH_CHECK_INTERVAL</span><span class="p">)</span>
    
    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">health_check_task</span><span class="p">())</span>
    
    <span class="k">yield</span>  <span class="c1"># Control passes to the app here</span></div>


<span class="c1"># Initialize FastAPI</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Multi-Agent LLM Backend&quot;</span><span class="p">,</span> <span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span><span class="p">)</span>

<span class="c1"># Add CORS middleware to allow cross-origin requests</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">CORSMiddleware</span><span class="p">,</span>
    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>  <span class="c1"># Allow all origins</span>
    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>  <span class="c1"># Allow all methods</span>
    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>  <span class="c1"># Allow all headers</span>
<span class="p">)</span>

<span class="c1"># Store active jobs</span>
<span class="n">active_jobs</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Define request models for API</span>
<div class="viewcode-block" id="QueryRequest">
<a class="viewcode-back" href="../modules.html#server.QueryRequest">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">QueryRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    QueryRequest is a data model representing the structure of a query request.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        query (str): The query string provided by the user.</span>
<span class="sd">        api_key (str, optional): An optional API key for authentication. Defaults to None.</span>
<span class="sd">        question_type (str): The type of question being asked. Defaults to &quot;None&quot;.</span>
<span class="sd">        domain (str): The domain or context of the query. Defaults to &quot;None&quot;.</span>
<span class="sd">        aggregator_id (str, optional): An optional identifier for the aggregator. Defaults to None.</span>
<span class="sd">        username (str): The username of the individual making the query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">question_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
    <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
    <span class="n">aggregator_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ethical_views</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="AggregatorRequest">
<a class="viewcode-back" href="../modules.html#server.AggregatorRequest">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AggregatorRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a request model for an aggregator.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        aggregator_id (str): A unique identifier for the aggregator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aggregator_id</span><span class="p">:</span> <span class="nb">str</span></div>


<div class="viewcode-block" id="ExampleRequest">
<a class="viewcode-back" href="../modules.html#server.ExampleRequest">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ExampleRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ExampleRequest is a data model representing a request structure.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        domain (str): The domain name or identifier associated with the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span></div>


<div class="viewcode-block" id="FillQueryRequest">
<a class="viewcode-back" href="../modules.html#server.FillQueryRequest">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FillQueryRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FillQueryRequest is a data model representing a request to fill a query.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        selected_example (str): The selected example to be used in the query.</span>
<span class="sd">        domain (str): The domain or context in which the query is being executed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">selected_example</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span></div>


<div class="viewcode-block" id="OpenRouterClient">
<a class="viewcode-back" href="../modules.html#server.OpenRouterClient">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OpenRouterClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OpenRouterClient is a class designed to interact with the OpenRouter API for generating responses,</span>
<span class="sd">    analyzing text embeddings, and performing sentiment and emotional tone analysis.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        api_key (str): The API key used for authenticating with the OpenRouter API.</span>
<span class="sd">        site_url (str, optional): The URL of the site making the request, used for HTTP-Referer header.</span>
<span class="sd">        site_name (str, optional): The name of the site making the request, used for X-Title header.</span>
<span class="sd">        url (str): The endpoint URL for the OpenRouter API.</span>
<span class="sd">        sentence_encoder (SentenceTransformer): A pre-trained model for generating text embeddings.</span>
<span class="sd">        sentiment_analyzer (SentimentIntensityAnalyzer): A VADER sentiment analyzer for sentiment analysis.</span>
<span class="sd">    </span>
<span class="sd">    Methods:</span>
<span class="sd">        generate_response(model_name: str, prompt: str, temperature: float = 0.7) -&gt; str:</span>
<span class="sd">            Asynchronously generates a response from a specified model via the OpenRouter API.</span>
<span class="sd">            Includes fault tolerance and error handling for API failures.</span>
<span class="sd">        get_embeddings(texts: List[str]) -&gt; np.ndarray:</span>
<span class="sd">            Generates embeddings for a list of input texts using a pre-trained sentence transformer.</span>
<span class="sd">        analyze_emotional_tones(text: str) -&gt; Dict[str, float]:</span>
<span class="sd">            Analyzes emotional tones in the input text using pattern matching and sentiment analysis.</span>
<span class="sd">            Returns a dictionary of emotional tone scores.</span>
<span class="sd">        analyze_sentiment(text: str) -&gt; Dict[str, Any]:</span>
<span class="sd">            Analyzes the sentiment of the input text using VADER and TextBlob.</span>
<span class="sd">            Returns a dictionary containing polarity, compound score, subjectivity, and emotional tones.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">site_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">site_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the server with the provided API key, optional site URL, and site name.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            api_key (str): The API key used for authentication.</span>
<span class="sd">            site_url (str, optional): The URL of the site. Defaults to None.</span>
<span class="sd">            site_name (str, optional): The name of the site. Defaults to None.</span>
<span class="sd">        </span>
<span class="sd">        Attributes:</span>
<span class="sd">            api_key (str): Stores the provided API key.</span>
<span class="sd">            site_url (str): Stores the provided site URL.</span>
<span class="sd">            site_name (str): Stores the provided site name.</span>
<span class="sd">            url (str): The endpoint URL for chat completions.</span>
<span class="sd">            sentence_encoder (SentenceTransformer): An instance of SentenceTransformer for encoding sentences.</span>
<span class="sd">            sentiment_analyzer (SentimentIntensityAnalyzer): An instance of SentimentIntensityAnalyzer for sentiment analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_url</span> <span class="o">=</span> <span class="n">site_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_name</span> <span class="o">=</span> <span class="n">site_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://openrouter.ai/api/v1/chat/completions&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentence_encoder</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s1">&#39;all-MiniLM-L6-v2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentiment_analyzer</span> <span class="o">=</span> <span class="n">SentimentIntensityAnalyzer</span><span class="p">()</span>
    
<div class="viewcode-block" id="OpenRouterClient.generate_response">
<a class="viewcode-back" href="../modules.html#server.OpenRouterClient.generate_response">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronously generates a response from a specified model based on the given prompt.</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            model_name (str): The name of the model to use for generating the response.</span>
<span class="sd">            prompt (str): The input prompt to send to the model.</span>
<span class="sd">            temperature (float, optional): The sampling temperature for the model&#39;s response. </span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: The generated response from the model, or an error message if the operation fails.</span>
<span class="sd">    </span>
<span class="sd">        Raises:</span>
<span class="sd">            asyncio.TimeoutError: If the API request times out.</span>
<span class="sd">            Exception: For any other unexpected errors during the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get model ID from model name</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">mid</span> <span class="k">for</span> <span class="n">mid</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">model_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_id</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: Unknown model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># Update heartbeat at the start</span>
        <span class="k">await</span> <span class="n">update_agent_heartbeat</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
        
        <span class="c1"># Check if agent is marked as failed and max retries exceeded</span>
        <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">agent_health</span> <span class="ow">and</span> <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span> <span class="ow">and</span> <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;retries&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MAX_RETRIES</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> has failed too many times and is disabled&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: Model </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> is currently unavailable&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_url</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;HTTP-Referer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_url</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_name</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_name</span>
            
            <span class="c1"># Use longer response for aggregator</span>
            <span class="n">model_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">mid</span> <span class="k">for</span> <span class="n">mid</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">model_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">max_tokens</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="k">if</span> <span class="n">model_id</span> <span class="ow">and</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aggregator&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">max_tokens</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># or 1500 if needed</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span>
                    <span class="p">}</span>
                <span class="p">],</span>
                <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">temperature</span><span class="p">,</span>
                <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="n">max_tokens</span>
            <span class="p">}</span>

            <span class="c1"># Make API request asynchronously with timeout</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span>
                        <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">,</span>
                        <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span>  <span class="c1"># 30 second timeout</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                <span class="c1"># Mark agent as unhealthy on timeout</span>
                <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="p">:</span>
                    <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unhealthy&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout when calling </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: Timeout when calling </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span>
        
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">update_agent_heartbeat</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="p">:</span>
                    <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;retries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;choices&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;message&quot;</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Handle specific 400 error for invalid model ID</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">error_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s2">&quot;not a valid model ID&quot;</span> <span class="ow">in</span> <span class="n">error_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="p">:</span>
                                <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
                                <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;retries&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid model ID for </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">. Marked as failed.&quot;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: Invalid model ID &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">parse_error</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing 400 response: </span><span class="si">{</span><span class="n">parse_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># General failure handling</span>
                <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="p">:</span>
                    <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
                        <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;retries&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API error for </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: API returned status code </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Increment failure count</span>
            <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="p">:</span>
                <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
                    <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;retries&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating with </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error with </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>

        
<div class="viewcode-block" id="OpenRouterClient.get_embeddings">
<a class="viewcode-back" href="../modules.html#server.OpenRouterClient.get_embeddings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate embeddings for a list of input texts.</span>

<span class="sd">        Args:</span>
<span class="sd">            texts (List[str]): A list of strings for which embeddings are to be generated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: A NumPy array containing the embeddings for the input texts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentence_encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="OpenRouterClient.analyze_emotional_tones">
<a class="viewcode-back" href="../modules.html#server.OpenRouterClient.analyze_emotional_tones">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_emotional_tones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze the emotional tones present in a given text.</span>

<span class="sd">        This method evaluates the input text for specific emotional tones such as </span>
<span class="sd">        Empathetic, Judgmental, Analytical, Ambivalent, Defensive, and Curious. </span>
<span class="sd">        It uses predefined regex patterns to detect tone-related keywords and </span>
<span class="sd">        incorporates sentiment analysis using VADER to adjust tone scores.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): The input text to analyze.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, float]: A dictionary where keys are emotional tone categories </span>
<span class="sd">            and values are their respective normalized scores (rounded to 4 decimal places).</span>
<span class="sd">            The scores represent the relative presence of each tone in the text.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lower_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Empathetic&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\b(empath(y|ize)|understand|support|care for|compassion)\b&#39;</span><span class="p">],</span>
            <span class="s2">&quot;Judgmental&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\b(should|must|wrong|bad|flawed|unacceptable)\b&#39;</span><span class="p">],</span>
            <span class="s2">&quot;Analytical&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\b(analy(z|s)e|data|logic|evaluate|evidence|rational)\b&#39;</span><span class="p">],</span>
            <span class="s2">&quot;Ambivalent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\b(however|but|on the other hand|conflicted|mixed feelings)\b&#39;</span><span class="p">],</span>
            <span class="s2">&quot;Defensive&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\b(defend|protect|warn|risk|caution|danger|threat)\b&#39;</span><span class="p">],</span>
            <span class="s2">&quot;Curious&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\b(curious|wonder|interesting|explore|what if|question)\b&#39;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">tone</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">tone</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">}</span>

        <span class="n">total_words</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lower_text</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">tone</span><span class="p">,</span> <span class="n">regs</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">:</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">lower_text</span><span class="p">)</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">tone</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>

        <span class="c1"># Normalize (softmax-style without exp)</span>
        <span class="n">total_hits</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">total_hits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tone</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">tone</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">tone</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_hits</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;Analytical&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># default fallback</span>

        <span class="c1"># Add VADER sentiment influence</span>
        <span class="n">sentiment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentiment_analyzer</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;Empathetic&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sentiment</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.3</span>
        <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;Judgmental&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sentiment</span><span class="p">[</span><span class="s2">&quot;neg&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.2</span>
        <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;Analytical&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sentiment</span><span class="p">[</span><span class="s2">&quot;neu&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span>

        <span class="c1"># Normalize again</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tone</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">tone</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">tone</span><span class="p">]</span> <span class="o">/</span> <span class="n">total</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scores</span></div>

    
<div class="viewcode-block" id="OpenRouterClient.analyze_sentiment">
<a class="viewcode-back" href="../modules.html#server.OpenRouterClient.analyze_sentiment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_sentiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyzes the sentiment and emotional tone of the given text.</span>
<span class="sd">        This method combines sentiment analysis from VADER and TextBlob to calculate</span>
<span class="sd">        an average polarity and subjectivity score. It also evaluates emotional tones</span>
<span class="sd">        and determines a contextual tone based on the polarity.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            text (str): The input text to analyze.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: A dictionary containing the following keys:</span>
<span class="sd">                - &#39;polarity&#39; (float): The average polarity score from VADER and TextBlob.</span>
<span class="sd">                - &#39;compound&#39; (float): The compound sentiment score from VADER.</span>
<span class="sd">                - &#39;subjectivity&#39; (float): The subjectivity score from TextBlob.</span>
<span class="sd">                - &#39;emotional_tones&#39; (Dict[str, float]): A dictionary of emotional tones and their scores.</span>
<span class="sd">                - &#39;tone_context&#39; (str): A contextual description of the top emotional tone combined with sentiment polarity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vader_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentiment_analyzer</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="n">TextBlob</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">sentiment</span>

        <span class="c1"># Average polarity (safer)</span>
        <span class="n">polarity</span> <span class="o">=</span> <span class="p">(</span><span class="n">vader_scores</span><span class="p">[</span><span class="s1">&#39;compound&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">blob</span><span class="o">.</span><span class="n">polarity</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">subjectivity</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">subjectivity</span>

        <span class="n">emotional_tones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_emotional_tones</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># Top emotional tone</span>
        <span class="n">top_tone</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">emotional_tones</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Simple tone context rule</span>
        <span class="k">if</span> <span class="n">polarity</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">:</span>
            <span class="n">tone_context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">top_tone</span><span class="si">}</span><span class="s2"> but Critical&quot;</span>
        <span class="k">elif</span> <span class="n">polarity</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">tone_context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">top_tone</span><span class="si">}</span><span class="s2"> and Supportive&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tone_context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">top_tone</span><span class="si">}</span><span class="s2"> and Neutral&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;polarity&#39;</span><span class="p">:</span> <span class="n">polarity</span><span class="p">,</span>
            <span class="s1">&#39;compound&#39;</span><span class="p">:</span> <span class="n">vader_scores</span><span class="p">[</span><span class="s1">&#39;compound&#39;</span><span class="p">],</span>
            <span class="s1">&#39;subjectivity&#39;</span><span class="p">:</span> <span class="n">subjectivity</span><span class="p">,</span>
            <span class="s1">&#39;emotional_tones&#39;</span><span class="p">:</span> <span class="n">emotional_tones</span><span class="p">,</span>
            <span class="s1">&#39;tone_context&#39;</span><span class="p">:</span> <span class="n">tone_context</span>
        <span class="p">}</span></div>
</div>


<div class="viewcode-block" id="ResponseAggregator">
<a class="viewcode-back" href="../modules.html#server.ResponseAggregator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ResponseAggregator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is responsible for processing queries through multiple AI models, aggregating their responses, </span>
<span class="sd">    and generating a consensus summary. It also provides analysis of the responses, including sentiment, </span>
<span class="sd">    similarity, and visualization of key metrics.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        client (Any): The client used to interact with AI models for generating responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">openrouter_client</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the server with the given OpenRouter client.</span>

<span class="sd">        Args:</span>
<span class="sd">            openrouter_client: An instance of the OpenRouter client used for communication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">openrouter_client</span>
    
<div class="viewcode-block" id="ResponseAggregator.process_query">
<a class="viewcode-back" href="../modules.html#server.ResponseAggregator.process_query">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">question_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">ethical_views</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a query through multiple agent models, aggregate their responses, and provide a consensus summary.</span>
<span class="sd">        This method performs the following steps:</span>
<span class="sd">        1. Formats the query based on the specified question type.</span>
<span class="sd">        2. Checks the health of agent models and selects up to three healthy models for processing.</span>
<span class="sd">        3. Sends the query to the selected models asynchronously and collects their responses.</span>
<span class="sd">        4. Identifies an aggregator model to summarize the responses, with failover to backup models if necessary.</span>
<span class="sd">        5. Generates a consensus summary using the aggregator model.</span>
<span class="sd">        6. Analyzes the responses and returns the results.</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            query (str): The input query to process.</span>
<span class="sd">            question_type (str, optional): The type of question, used to apply a prefix to the query. Defaults to &quot;none&quot;.</span>
<span class="sd">            ethical_views (List[str], optional): A list of atmost 3 ethical perspectives or [&quot;None&quot;] to skip role assignments.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: A dictionary containing the some keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_responses</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Apply prefix based on question type</span>
        <span class="k">if</span> <span class="n">question_type</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span> <span class="ow">and</span> <span class="n">question_type</span> <span class="ow">in</span> <span class="n">QUESTION_PREFIXES</span><span class="p">:</span>
            <span class="n">formatted_query</span> <span class="o">=</span> <span class="n">QUESTION_PREFIXES</span><span class="p">[</span><span class="n">question_type</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">formatted_query</span> <span class="o">=</span> <span class="n">query</span>
        
        <span class="c1"># Check agent health before processing</span>
        <span class="k">await</span> <span class="n">check_agent_health</span><span class="p">()</span>

        <span class="c1"># STEP 1: Pick up to 3 healthy agent models (excluding aggregator)</span>
        <span class="n">available_agents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aggregator&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># Skip aggregator</span>

            <span class="n">health</span> <span class="o">=</span> <span class="n">agent_health</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">health</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span> <span class="ow">and</span> <span class="n">health</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;retries&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_RETRIES</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping failed model </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> (too many retries)&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">health</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;unhealthy&quot;</span><span class="p">]:</span>
                <span class="n">available_agents</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">model_id</span><span class="p">,</span> <span class="n">config</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_agents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">break</span>  <span class="c1"># stop once we have 3</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected agent models for query: </span><span class="si">{</span><span class="p">[</span><span class="n">aid</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">aid</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">available_agents</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># assign ethics after agent IDs are known</span>
        <span class="n">agent_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_id</span> <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">available_agents</span><span class="p">]</span>
        <span class="n">ethics_map</span> <span class="o">=</span> <span class="n">assign_ethics_to_agents</span><span class="p">(</span><span class="n">agent_ids</span><span class="p">,</span> <span class="n">ethical_views</span><span class="p">)</span>
        
        <span class="c1"># STEP 2: Start async tasks for those agents</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">available_agents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ethics_map</span><span class="p">[</span><span class="n">model_id</span><span class="p">]:</span>
                <span class="n">agent_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ethics_map</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">formatted_query</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">agent_prompt</span> <span class="o">=</span> <span class="n">formatted_query</span>

            <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">generate_response</span><span class="p">(</span>
                    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                    <span class="n">agent_prompt</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">model_id</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>

        <span class="c1"># STEP 3: Await their responses and record results</span>
        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                <span class="n">model_responses</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span>
                <span class="k">await</span> <span class="n">update_agent_heartbeat</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout for model </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">model_responses</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: Timeout for model </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="p">:</span>
                    <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unhealthy&quot;</span>
                    <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error with </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">model_responses</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="p">:</span>
                    <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unhealthy&quot;</span>
                    <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    
        <span class="c1"># Identify aggregator and check its health</span>
        <span class="n">aggregator_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">model_id</span> <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aggregator&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">aggregator_backup_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># If primary aggregator is unhealthy, choose a backup</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aggregator_id</span> <span class="ow">and</span> <span class="n">aggregator_id</span> <span class="ow">in</span> <span class="n">agent_health</span> <span class="ow">and</span> 
            <span class="p">(</span><span class="n">agent_health</span><span class="p">[</span><span class="n">aggregator_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unhealthy&quot;</span> <span class="ow">or</span> 
            <span class="n">agent_health</span><span class="p">[</span><span class="n">aggregator_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">)):</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Primary aggregator </span><span class="si">{</span><span class="n">aggregator_id</span><span class="si">}</span><span class="s2"> is unhealthy, selecting backup&quot;</span><span class="p">)</span>
            
            <span class="c1"># Find a healthy model to use as backup aggregator</span>
            <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">health</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">health</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;healthy&quot;</span> <span class="ow">and</span> <span class="n">model_id</span> <span class="o">!=</span> <span class="n">aggregator_id</span><span class="p">:</span>
                    <span class="n">aggregator_backup_id</span> <span class="o">=</span> <span class="n">model_id</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> as backup aggregator&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">aggregator_backup_id</span><span class="p">:</span>
                <span class="n">aggregator_id</span> <span class="o">=</span> <span class="n">aggregator_backup_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No healthy models available to act as backup aggregator&quot;</span><span class="p">)</span>

        <span class="c1"># Generate consensus summary using the aggregator model</span>
        <span class="c1"># 1. Handle case: no aggregator selected (safety check)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">aggregator_id</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No aggregator model specified in MODELS.&quot;</span><span class="p">)</span>
            <span class="n">consensus_summary</span> <span class="o">=</span> <span class="s2">&quot;Error: No aggregator model was selected for summarization.&quot;</span>

        <span class="c1"># 2. Handle case: only one model remains (no aggregation possible)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_responses</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">aggregator_id</span> <span class="ow">in</span> <span class="n">model_responses</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only one model (</span><span class="si">{</span><span class="n">aggregator_id</span><span class="si">}</span><span class="s2">) is available — skipping aggregation.&quot;</span><span class="p">)</span>
            <span class="n">consensus_summary</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;**[Only one model was available. This is a direct response from the aggregator.]**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="n">model_responses</span><span class="p">[</span><span class="n">aggregator_id</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># 3. Normal case: multiple models — perform aggregation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">consensus_summary</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_consensus_summary</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">model_responses</span><span class="p">,</span> <span class="n">aggregator_id</span><span class="p">)</span>
            <span class="n">model_responses</span><span class="p">[</span><span class="n">aggregator_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">consensus_summary</span>

            <span class="c1"># Start fallback loop if the consensus was invalid</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">is_invalid_consensus</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Determines if the given text indicates an invalid consensus.</span>

<span class="sd">                Args:</span>
<span class="sd">                    text (str): The input text to evaluate.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    bool: True if the text suggests an invalid consensus, otherwise False.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="s2">&quot;invalid model id&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span>
                    <span class="s2">&quot;cannot generate consensus&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="p">)</span>

            <span class="n">tried_aggregators</span> <span class="o">=</span> <span class="p">{</span><span class="n">aggregator_id</span><span class="p">}</span>
            <span class="c1"># Get agent model IDs (used earlier in agent response generation)</span>
            <span class="n">agent_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_id</span> <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">available_agents</span><span class="p">]</span>

            <span class="k">while</span> <span class="n">is_invalid_consensus</span><span class="p">(</span><span class="n">consensus_summary</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aggregator </span><span class="si">{</span><span class="n">aggregator_id</span><span class="si">}</span><span class="s2"> failed during summarization. Attempting fallback...&quot;</span><span class="p">)</span>

                <span class="c1"># Priority 1: healthy models not used as agents</span>
                <span class="n">primary_fallbacks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">model_id</span> <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">health</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">health</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;healthy&quot;</span>
                    <span class="ow">and</span> <span class="n">model_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tried_aggregators</span>
                    <span class="ow">and</span> <span class="n">model_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent_ids</span>
                <span class="p">]</span>

                <span class="c1"># Priority 2: healthy agent models</span>
                <span class="n">secondary_fallbacks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">model_id</span> <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">agent_ids</span>
                    <span class="k">if</span> <span class="n">model_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tried_aggregators</span>
                    <span class="ow">and</span> <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;healthy&quot;</span>
                <span class="p">]</span>

                <span class="n">fallback_candidates</span> <span class="o">=</span> <span class="n">primary_fallbacks</span> <span class="o">+</span> <span class="n">secondary_fallbacks</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fallback_candidates</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No healthy model available for aggregator fallback.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="n">aggregator_id</span> <span class="o">=</span> <span class="n">fallback_candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tried_aggregators</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">aggregator_id</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fallback aggregator selected: </span><span class="si">{</span><span class="n">aggregator_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">consensus_summary</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_consensus_summary</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">model_responses</span><span class="p">,</span> <span class="n">aggregator_id</span><span class="p">)</span>
                <span class="n">model_responses</span><span class="p">[</span><span class="n">aggregator_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">consensus_summary</span>



        <span class="c1"># Analyze responses</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_responses</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">model_responses</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
            <span class="s2">&quot;formatted_query&quot;</span><span class="p">:</span> <span class="n">formatted_query</span><span class="p">,</span>
            <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="n">model_responses</span><span class="p">,</span>
            <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">,</span>
            <span class="s2">&quot;consensus_summary&quot;</span><span class="p">:</span> <span class="n">consensus_summary</span><span class="p">,</span>
            <span class="s2">&quot;aggregator_id&quot;</span><span class="p">:</span> <span class="n">aggregator_id</span>
        <span class="p">}</span></div>

    
<div class="viewcode-block" id="ResponseAggregator.generate_consensus_summary">
<a class="viewcode-back" href="../modules.html#server.ResponseAggregator.generate_consensus_summary">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_consensus_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">responses</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">aggregator_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a summarized consensus from all model responses using the aggregator model.</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            query (str): The query or prompt that was provided to the models.</span>
<span class="sd">            responses (Dict[str, str]): A dictionary mapping model IDs to their respective responses.</span>
<span class="sd">            aggregator_id (str): The ID of the designated aggregator model.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: A comprehensive consensus summary generated by the aggregator model. If all models fail </span>
<span class="sd">                 or encounter errors, a fallback message is returned indicating the inability to generate a summary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check for errors</span>
        <span class="n">agg_response</span> <span class="o">=</span> <span class="n">responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aggregator_id</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">valid_agent_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="mi">1</span> <span class="k">for</span> <span class="n">mid</span><span class="p">,</span> <span class="n">resp</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mid</span> <span class="o">!=</span> <span class="n">aggregator_id</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;could not generate&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s2">&quot;choices&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">agg_response</span> <span class="ow">or</span>
            <span class="n">agg_response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">agg_response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;could not generate&quot;</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">valid_agent_count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Could not generate a summary. All models failed or encountered an error.&quot;</span>

        <span class="n">responses_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

        <span class="n">summary_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        As an AI aggregator, analyze and synthesize the following AI responses to this query: &quot;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="s2">        Here are the responses from different models:</span>

<span class="s2">        </span><span class="si">{</span><span class="n">responses_text</span><span class="si">}</span>

<span class="s2">        Your task is to create a balanced consensus summary with the following objectives:</span>

<span class="s2">        1. Identify whether a majority of the models share a common stance, opinion, or recommendation.</span>
<span class="s2">        2. If a majority consensus exists, present it clearly and support it with reasoning derived from the responses.</span>
<span class="s2">        3. If no clear majority exists, evaluate the arguments and cast your own reasoned &#39;vote&#39; to propose a unified conclusion.</span>
<span class="s2">        4. Highlight the points of agreement between models and describe any major disagreements.</span>
<span class="s2">        5. Include a nuanced synthesis of all perspectives, noting the strengths and weaknesses of each.</span>

<span class="s2">        Your summary should be comprehensive, thoughtful, and concise. You are the aggregator model responsible for making a final decision, when needed.</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="c1"># Use the designated aggregator model</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">aggregator_id</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        
        <span class="n">summary</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">generate_response</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">prompt</span><span class="o">=</span><span class="n">summary_prompt</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">0.3</span>  <span class="c1"># Lower temperature for more consistent summaries</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">summary</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">summary</span>
        <span class="c1"># Add prefix to indicate this is from the aggregator model</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;SUMMARY</span><span class="se">\n\n</span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span></div>

    
<div class="viewcode-block" id="ResponseAggregator.analyze_responses">
<a class="viewcode-back" href="../modules.html#server.ResponseAggregator.analyze_responses">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">analyze_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">responses</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze the responses from different models and generate insights. This method </span>
<span class="sd">        processes the responses from various models, performs sentiment analysis,</span>
<span class="sd">        calculates similarity metrics, and generates visualizations to provide insights into</span>
<span class="sd">        the responses. If there are fewer than two valid responses, it skips the visual analysis</span>
<span class="sd">        and returns basic metrics with a warning.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (str): The input query for which the responses were generated.</span>
<span class="sd">            responses (Dict[str, str]): A dictionary model IDs as keys and responses as values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: A dictionary containing the some keys.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If an error occurs during the analysis process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">valid_responses</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;could not generate&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">valid_responses</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span>
                <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_responses</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not enough valid model responses for visual analysis (&lt;2). Skipping plots.&quot;</span><span class="p">)</span>

            <span class="n">sentiment_analysis</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">model_id</span><span class="p">:</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">analyze_sentiment</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">valid_responses</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;sentiment_analysis&quot;</span><span class="p">:</span> <span class="n">sentiment_analysis</span><span class="p">,</span>
                <span class="s2">&quot;response_lengths&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">mid</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">mid</span><span class="p">,</span> <span class="n">resp</span> <span class="ow">in</span> <span class="n">valid_responses</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                <span class="s2">&quot;consensus_score&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;heatmap&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;emotion_chart&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;polarity_chart&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;radar_chart&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="s2">&quot;Not enough valid model responses for visual analysis (&lt;2). Skipping plots.&quot;</span>
            <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Proceed with full analysis if we have enough responses</span>
            <span class="n">embeddings</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_embeddings</span><span class="p">,</span> <span class="n">texts</span><span class="p">)</span>

            <span class="c1"># Calculate similarity matrix</span>
            <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">model_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">valid_responses</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_ids</span><span class="p">):</span>
                <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">model_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">model_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_ids</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
                        <span class="n">sim</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cosine</span><span class="p">(</span><span class="n">embeddings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">embeddings</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">model_i</span><span class="p">][</span><span class="n">model_j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>

            <span class="c1"># Lengths of all valid responses</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="p">{</span><span class="n">model_id</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">resp</span> <span class="ow">in</span> <span class="n">valid_responses</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">avg_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">lengths</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>

            <span class="c1"># Sentiment &amp; emotional tone</span>
            <span class="n">sentiment_analysis</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">valid_responses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sentiment_analysis</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">analyze_sentiment</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

            <span class="c1"># Consensus score = average of all pairwise similarities</span>
            <span class="n">agreement_scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">sims</span> <span class="ow">in</span> <span class="n">similarity_matrix</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sims</span><span class="p">:</span>
                    <span class="n">agreement_scores</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sims</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">consensus_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">agreement_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">agreement_scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">agreement_scores</span> <span class="k">else</span> <span class="mf">1.0</span>

            <span class="c1"># Generate plots</span>
            <span class="n">similarity_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">heatmap_img</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_heatmap</span><span class="p">,</span> <span class="n">similarity_df</span><span class="p">)</span>
            <span class="n">emotion_img</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_emotion_chart</span><span class="p">,</span> <span class="n">sentiment_analysis</span><span class="p">)</span>
            <span class="n">polarity_img</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_polarity_chart</span><span class="p">,</span> <span class="n">sentiment_analysis</span><span class="p">)</span>
            <span class="n">radar_img</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_radar_chart</span><span class="p">,</span> <span class="n">valid_responses</span><span class="p">,</span> <span class="n">sentiment_analysis</span><span class="p">,</span> <span class="n">lengths</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;similarity_matrix&quot;</span><span class="p">:</span> <span class="n">similarity_matrix</span><span class="p">,</span>
                <span class="s2">&quot;response_lengths&quot;</span><span class="p">:</span> <span class="n">lengths</span><span class="p">,</span>
                <span class="s2">&quot;avg_response_length&quot;</span><span class="p">:</span> <span class="n">avg_length</span><span class="p">,</span>
                <span class="s2">&quot;sentiment_analysis&quot;</span><span class="p">:</span> <span class="n">sentiment_analysis</span><span class="p">,</span>
                <span class="s2">&quot;consensus_score&quot;</span><span class="p">:</span> <span class="n">consensus_score</span><span class="p">,</span>
                <span class="s2">&quot;heatmap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_to_base64</span><span class="p">(</span><span class="n">heatmap_img</span><span class="p">),</span>
                <span class="s2">&quot;emotion_chart&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_to_base64</span><span class="p">(</span><span class="n">emotion_img</span><span class="p">),</span>
                <span class="s2">&quot;polarity_chart&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_to_base64</span><span class="p">(</span><span class="n">polarity_img</span><span class="p">),</span>
                <span class="s2">&quot;radar_chart&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_to_base64</span><span class="p">(</span><span class="n">radar_img</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in analysis: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Analysis failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>


    
    <span class="k">def</span><span class="w"> </span><span class="nf">_image_to_base64</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a PIL Image object to a Base64-encoded string.</span>

<span class="sd">        Args:</span>
<span class="sd">            img (Image.Image): The PIL Image object to be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A Base64-encoded string representation of the image, prefixed with</span>
<span class="sd">                 &quot;data:image/png;base64,&quot; to indicate the image format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
        <span class="n">img_str</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;data:image/png;base64,</span><span class="si">{</span><span class="n">img_str</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_heatmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a heatmap visualization from a given pandas DataFrame.</span>
<span class="sd">        This method creates a heatmap using seaborn, with annotations and a color map</span>
<span class="sd">        ranging from yellow to blue. The heatmap is saved to an in-memory buffer as a PNG</span>
<span class="sd">        image and returned as a PIL Image object.</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): The input DataFrame containing the data to be visualized</span>
<span class="sd">                in the heatmap. The values should be normalized between 0 and 1.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            Image.Image: A PIL Image object containing the generated heatmap.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;YlGnBu&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Response Similarity Matrix&quot;</span><span class="p">)</span>
        
        <span class="c1"># Save plot to bytes buffer</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_emotion_chart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentiment_analysis</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a stacked bar chart visualizing emotional tone analysis for different models.</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            sentiment_analysis (Dict[str, Dict]): A dictionary where keys are model names and values </span>
<span class="sd">                are dictionaries containing emotional tone data under the key &#39;emotional_tones&#39;.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            Image.Image: A PIL Image object containing the generated chart.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract emotion data</span>
        <span class="n">emotions_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="n">sentiment_analysis</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">emotions_data</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;emotional_tones&#39;</span><span class="p">]</span>
        
        <span class="c1"># Create DataFrame from emotional tones</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">emotions_data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        
        <span class="c1"># Create stacked bar chart</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        
        <span class="c1"># Custom color palette for emotions (not model-specific)</span>
        <span class="n">emotion_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#2ecc71&#39;</span><span class="p">,</span> <span class="s1">&#39;#e74c3c&#39;</span><span class="p">,</span> <span class="s1">&#39;#3498db&#39;</span><span class="p">,</span> <span class="s1">&#39;#9b59b6&#39;</span><span class="p">,</span> <span class="s1">&#39;#f39c12&#39;</span><span class="p">,</span> <span class="s1">&#39;#1abc9c&#39;</span><span class="p">]</span>
        
        <span class="n">ax</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">emotion_colors</span><span class="p">)</span>
        
        <span class="c1"># Add labels and title</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Emotional Tone Analysis by Model&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Proportion&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Emotional Tone&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
        
        <span class="c1"># Add percentage labels on bars (show only if segment &gt; 5%)</span>
        <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">containers</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">%&#39;</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">datavalues</span> <span class="o">*</span> <span class="mi">100</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar_label</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">label_type</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
        <span class="c1"># Save plot to bytes buffer</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_polarity_chart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentiment_analysis</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a bar chart visualizing sentiment polarity scores for different models.</span>

<span class="sd">        Args:</span>
<span class="sd">            sentiment_analysis (Dict[str, Dict]): A dictionary where keys are model names and </span>
<span class="sd">                values are dictionaries containing sentiment analysis results, including a </span>
<span class="sd">                &#39;compound&#39; key representing the polarity score (-1 to +1).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Image.Image: A PIL Image object containing the generated bar chart.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract polarity scores</span>
        <span class="n">polarity_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">model</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;compound&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="n">sentiment_analysis</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        
        <span class="c1"># Use consistent colors for each model</span>
        <span class="n">model_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">MODEL_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;#95a5a6&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">polarity_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        
        <span class="c1"># Create bar chart</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">bars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polarity_data</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="n">polarity_data</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">color</span><span class="o">=</span><span class="n">model_colors</span><span class="p">)</span>
        
        <span class="c1"># Add labels and title</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sentiment Polarity by Model&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Polarity Score (-1 to +1)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polarity_data</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="n">polarity_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Add value labels on top of bars</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">polarity_data</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.05</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        
        <span class="c1"># Set y-axis limits</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
        <span class="c1"># Save plot to bytes buffer</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_radar_chart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">responses</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">sentiment_analysis</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> 
                             <span class="n">lengths</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a radar/spider chart comparing response features with consistent colors.</span>

<span class="sd">        Args:</span>
<span class="sd">            responses (Dict[str, str]): A dictionary where keys are model names and values are their responses.</span>
<span class="sd">            sentiment_analysis (Dict[str, Dict]): A dictionary containing sentiment analysis results for each model.</span>
<span class="sd">                Each model&#39;s data should include:</span>
<span class="sd">                - &#39;polarity&#39;: Sentiment polarity score (float, range [-1, 1]).</span>
<span class="sd">                - &#39;subjectivity&#39;: Sentiment subjectivity score (float, range [0, 1]).</span>
<span class="sd">                - &#39;emotional_tones&#39;: A dictionary with keys &#39;Analytical&#39;, &#39;Empathetic&#39;, and &#39;Curious&#39;, </span>
<span class="sd">                   representing emotional tone scores (float, range [0, 1]).</span>
<span class="sd">            lengths (Dict[str, int]): A dictionary where keys are model names and values are the lengths of their responses.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Image.Image: A PIL Image object containing the radar chart visualization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prepare data for radar chart</span>
        <span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">responses</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="c1"># Define metrics</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Length&#39;</span><span class="p">,</span> <span class="s1">&#39;Polarity&#39;</span><span class="p">,</span> <span class="s1">&#39;Subjectivity&#39;</span><span class="p">,</span> <span class="s1">&#39;Analytical&#39;</span><span class="p">,</span> <span class="s1">&#39;Empathetic&#39;</span><span class="p">,</span> <span class="s1">&#39;Curious&#39;</span><span class="p">]</span>
        
        <span class="c1"># Create DataFrame</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lengths</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">lengths</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_length</span><span class="p">,</span>  <span class="c1"># Normalize length</span>
                <span class="p">(</span><span class="n">sentiment_analysis</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;polarity&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># Normalize polarity from [-1,1] to [0,1]</span>
                <span class="n">sentiment_analysis</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;subjectivity&#39;</span><span class="p">],</span>
                <span class="n">sentiment_analysis</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;emotional_tones&#39;</span><span class="p">][</span><span class="s1">&#39;Analytical&#39;</span><span class="p">],</span>
                <span class="n">sentiment_analysis</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;emotional_tones&#39;</span><span class="p">][</span><span class="s1">&#39;Empathetic&#39;</span><span class="p">],</span>
                <span class="n">sentiment_analysis</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;emotional_tones&#39;</span><span class="p">][</span><span class="s1">&#39;Curious&#39;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">models</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
        
        <span class="c1"># Plotting</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Number of variables</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
        
        <span class="c1"># Compute angle for each axis</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
        <span class="n">angles</span> <span class="o">+=</span> <span class="n">angles</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Close the loop</span>
        
        <span class="c1"># Draw the chart for each model with consistent colors</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">values</span> <span class="o">+=</span> <span class="n">values</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Close the loop</span>
            
            <span class="c1"># Use consistent colors for each model</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">MODEL_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;#95a5a6&#39;</span><span class="p">)</span>
            
            <span class="c1"># Plot values</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        
        <span class="c1"># Fix axis to go in the right order and start at 12 o&#39;clock</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_theta_offset</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_theta_direction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Draw axis lines for each angle and label</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">angles</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
        
        <span class="c1"># Draw y-axis labels</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;0.2&#39;</span><span class="p">,</span> <span class="s1">&#39;0.4&#39;</span><span class="p">,</span> <span class="s1">&#39;0.6&#39;</span><span class="p">,</span> <span class="s1">&#39;0.8&#39;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Add title and legend</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Response Feature Comparison&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
        
        <span class="c1"># Save plot to bytes buffer</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_aggregator">
<a class="viewcode-back" href="../modules.html#server.update_aggregator">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_aggregator</span><span class="p">(</span><span class="n">new_aggregator_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the aggregator status in the MODELS dictionary.</span>
<span class="sd">    This function resets the &#39;aggregator&#39; status for all models in the MODELS </span>
<span class="sd">    dictionary and sets the &#39;aggregator&#39; status to True for the model with the </span>
<span class="sd">    specified `new_aggregator_id`.</span>

<span class="sd">    Args:</span>
<span class="sd">        new_aggregator_id (str): The ID of the model to be set as the new aggregator.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The ID of the model that was set as the new aggregator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Reset all models&#39; aggregator status</span>
    <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;aggregator&#39;</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_id</span><span class="p">]:</span>
            <span class="n">MODELS</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s1">&#39;aggregator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="c1"># Set new aggregator</span>
    <span class="k">if</span> <span class="n">new_aggregator_id</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="p">:</span>
        <span class="n">MODELS</span><span class="p">[</span><span class="n">new_aggregator_id</span><span class="p">][</span><span class="s1">&#39;aggregator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">return</span> <span class="n">new_aggregator_id</span></div>


<span class="c1"># Initialize the OpenRouterClient</span>
<span class="n">openrouter_client</span> <span class="o">=</span> <span class="n">OpenRouterClient</span><span class="p">(</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">OPENROUTER_API_KEY</span><span class="p">,</span>
    <span class="n">site_url</span><span class="o">=</span><span class="n">SITE_URL</span><span class="p">,</span>
    <span class="n">site_name</span><span class="o">=</span><span class="n">SITE_NAME</span>
<span class="p">)</span>

<span class="c1"># Agent health tracking</span>
<span class="n">agent_health</span> <span class="o">=</span> <span class="p">{</span><span class="n">model_id</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;last_heartbeat&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>  <span class="c1"># Give 5 min grace period on startup</span>
    <span class="s2">&quot;failures&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;retries&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;has_processed_request&quot;</span><span class="p">:</span> <span class="kc">False</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

<span class="c1"># Initialize the ResponseAggregator</span>
<span class="n">response_aggregator</span> <span class="o">=</span> <span class="n">ResponseAggregator</span><span class="p">(</span><span class="n">openrouter_client</span><span class="p">)</span>

<div class="viewcode-block" id="update_agent_heartbeat">
<a class="viewcode-back" href="../modules.html#server.update_agent_heartbeat">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_agent_heartbeat</span><span class="p">(</span><span class="n">model_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the last heartbeat time and status for a specific agent.</span>

<span class="sd">    This function updates the `last_heartbeat` timestamp, sets the agent&#39;s </span>
<span class="sd">    status to &quot;healthy&quot;, and marks the agent as having processed a request </span>
<span class="sd">    in the `agent_health` dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_id (str): The unique identifier of the agent whose heartbeat </span>
<span class="sd">                        information is being updated.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If the provided `model_id` is not found in the `agent_health` dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="p">:</span>
        <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;last_heartbeat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>
        <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;has_processed_request&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Mark as having processed a request</span></div>


<div class="viewcode-block" id="check_agent_health">
<a class="viewcode-back" href="../modules.html#server.check_agent_health">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_agent_health</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Periodically checks the health of agents and updates their status based on heartbeat activity.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Any exceptions raised by `update_agent_heartbeat` or other asynchronous operations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    
    <span class="c1"># If any job is active/processing, refresh all heartbeats</span>
    <span class="n">active_processing</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;processing&quot;</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">active_jobs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">health</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">health</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">update_agent_heartbeat</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
      
    <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">health</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">health</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
            <span class="n">time_since_heartbeat</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">health</span><span class="p">[</span><span class="s2">&quot;last_heartbeat&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="c1"># Only mark as unhealthy if it&#39;s been significantly longer than the timeout</span>
            <span class="k">if</span> <span class="n">time_since_heartbeat</span> <span class="o">&gt;</span> <span class="n">HEALTH_TIMEOUT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> appears to be down - no heartbeat for </span><span class="si">{</span><span class="n">time_since_heartbeat</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
                <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unhealthy&quot;</span></div>


<div class="viewcode-block" id="reset_failed_agent">
<a class="viewcode-back" href="../modules.html#server.reset_failed_agent">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">reset_failed_agent</span><span class="p">(</span><span class="n">model_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reset the status of a failed agent to &quot;healthy&quot; and clear its failure and retry counts.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_id (str): The unique identifier of the agent to reset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="p">:</span>
        <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>
        <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;last_heartbeat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">agent_health</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;retries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> has been reset&quot;</span><span class="p">)</span></div>


<span class="c1"># API endpoints</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the root endpoint of the server.</span>

<span class="sd">    This asynchronous function returns a JSON response indicating that the </span>
<span class="sd">    Multi-Agent LLM Backend is operational.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing a message confirming the server&#39;s status.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Multi-Agent LLM Backend is running&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/update_aggregator&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_update_aggregator</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">AggregatorRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the API request to update an aggregator.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (AggregatorRequest): The request object containing the aggregator ID to be updated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the success status and the updated aggregator ID.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: If an error occurs during the update process, an HTTP 500 error is raised with the error details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_aggregator</span> <span class="o">=</span> <span class="n">update_aggregator</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">aggregator_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;aggregator_id&quot;</span><span class="p">:</span> <span class="n">new_aggregator</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/get_example_choices&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_get_example_choices</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">ExampleRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get example choices for a domain&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">EXAMPLES_BY_DOMAIN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="p">[])]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;examples&quot;</span><span class="p">:</span> <span class="n">examples</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/fill_query_and_type&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_fill_query_and_type</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">FillQueryRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the API request to fill a query and its corresponding question type </span>
<span class="sd">    based on a selected example.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (FillQueryRequest): The request object containing the domain </span>
<span class="sd">        and the selected example.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing:</span>
<span class="sd">            - &quot;query&quot; (str): The query string from the selected example.</span>
<span class="sd">            - &quot;question_type&quot; (str): The type of question associated with the query.</span>
<span class="sd">              Returns &quot;None&quot; if no matching example is found.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: If an unexpected error occurs, returns a 500 status code </span>
<span class="sd">        with the error details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">EXAMPLES_BY_DOMAIN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">selected_example</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;question_type&quot;</span><span class="p">:</span> <span class="n">example</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;question_type&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/history&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_get_history</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches the interaction history for a specified user.</span>

<span class="sd">    Args:</span>
<span class="sd">        username (str): The username of the user whose interaction history is to be retrieved.</span>
<span class="sd">        limit (int, optional): The maximum number of history records to retrieve. Defaults to 50.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the user&#39;s interaction history under the key &quot;history&quot;.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: If an error occurs while retrieving the history, an HTTP 500 error is raised with the error details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">get_user_history</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="n">history</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting history: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/history/</span><span class="si">{job_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_delete_history_item</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete an interaction from the user&#39;s history.</span>

<span class="sd">    Args:</span>
<span class="sd">        job_id (str): The unique identifier of the job or interaction to be deleted.</span>
<span class="sd">        username (str): The username of the user whose interaction history is being modified.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary indicating the success of the operation with a key &quot;success&quot; set to True if the deletion was successful.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: If the deletion fails or an unexpected error occurs, an HTTPException is raised with a status code of 500 and an appropriate error message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">delete_interaction</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Failed to delete interaction&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting history item: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/process_query&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_process_query</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">QueryRequest</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the processing of a query request asynchronously.</span>
<span class="sd">    This function updates agent heartbeats, validates the API key and query,</span>
<span class="sd">    applies domain prefixes if specified, updates the aggregator if provided,</span>
<span class="sd">    and starts a background task to process the query.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (QueryRequest): The query request object containing the query,</span>
<span class="sd">                                API key, domain, question type, username, and</span>
<span class="sd">                                optional aggregator ID.</span>
<span class="sd">        background_tasks (BackgroundTasks): The background tasks manager to</span>
<span class="sd">                                             schedule asynchronous tasks.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the job ID and the processing status.</span>
<span class="sd">              If there are validation errors, an error message is returned.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: If an unexpected error occurs during query processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Update all agent heartbeats at the start of any query</span>
        <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">update_agent_heartbeat</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>

        <span class="c1"># Update API key if provided</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="n">openrouter_client</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">api_key</span>
        
        <span class="c1"># Check for required fields</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">openrouter_client</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;OpenRouter API key is required&quot;</span>
            <span class="p">}</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Please enter a query&quot;</span>
            <span class="p">}</span>
        
        <span class="c1"># Create a job ID</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        
        <span class="c1"># Apply domain prefix if specified</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">domain</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">domain</span> <span class="ow">in</span> <span class="n">DOMAINS</span><span class="p">:</span>
            <span class="n">prefixed_query</span> <span class="o">=</span> <span class="n">DOMAINS</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">domain</span><span class="p">]</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">query</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefixed_query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query</span>
        
        <span class="c1"># Update aggregator if specified</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">aggregator_id</span><span class="p">:</span>
            <span class="n">update_aggregator</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">aggregator_id</span><span class="p">)</span>
        
        <span class="c1"># Start the processing task in the background</span>
        <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
            <span class="n">process_query_background</span><span class="p">,</span>
            <span class="n">job_id</span><span class="p">,</span> <span class="n">prefixed_query</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">question_type</span><span class="p">,</span>
            <span class="n">request</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">ethical_views</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">username</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;processing&quot;</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing query: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/job_status/</span><span class="si">{job_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_job_status</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the status of a specific job.</span>

<span class="sd">    Args:</span>
<span class="sd">        job_id (str): The unique identifier of the job.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The status information of the job if it exists in active_jobs.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: If the job_id is not found in active_jobs, a 404 error is raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">active_jobs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Job not found&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/job_result/</span><span class="si">{job_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_job_result</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the result of a job by its ID.</span>

<span class="sd">    This function checks if the job is currently active and returns its status or result.</span>
<span class="sd">    If the job is not active, it attempts to retrieve the job&#39;s result from the database.</span>
<span class="sd">    If found, the job&#39;s data is rehydrated into the active jobs for further use.</span>

<span class="sd">    Args:</span>
<span class="sd">        job_id (str): The unique identifier of the job.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the job&#39;s result, including responses, analysis,</span>
<span class="sd">              consensus score, query, question type, domain, and aggregator ID.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: If the job is not found in both active jobs and the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">active_jobs</span><span class="p">:</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;completed&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span>

    <span class="c1"># Fallback: Try from database</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">get_interaction</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Job not found&quot;</span><span class="p">)</span>

    <span class="n">responses</span> <span class="o">=</span> <span class="p">{</span><span class="n">agent_id</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">analysis</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">consensus_score</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;consensus_score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">aggregator_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">agent_id</span> <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_aggregator&quot;</span><span class="p">]),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Rehydrate active_jobs to make image routes work</span>
    <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="n">responses</span><span class="p">,</span>
            <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">,</span>
            <span class="s2">&quot;consensus_score&quot;</span><span class="p">:</span> <span class="n">consensus_score</span><span class="p">,</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">],</span>
            <span class="s2">&quot;question_type&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;question_type&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">),</span>
            <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;domain&quot;</span><span class="p">,</span> <span class="s2">&quot;Custom&quot;</span><span class="p">),</span>
            <span class="s2">&quot;aggregator_id&quot;</span><span class="p">:</span> <span class="n">aggregator_id</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/image/</span><span class="si">{job_id}</span><span class="s2">/</span><span class="si">{image_type}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_get_image</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">image_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve a specific type of image associated with a completed job.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        job_id (str): The unique identifier of the job.</span>
<span class="sd">        image_type (str): The type of image to retrieve.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: error codes</span>

<span class="sd">    Returns:</span>
<span class="sd">        StreamingResponse: A streaming response containing the requested image </span>
<span class="sd">                           in PNG format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">active_jobs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Job not found&quot;</span><span class="p">)</span>
    
    <span class="n">job</span> <span class="o">=</span> <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;completed&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Job not completed yet&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;result&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span> <span class="ow">or</span> <span class="s2">&quot;analysis&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;No analysis available&quot;</span><span class="p">)</span>
    
    <span class="n">analysis</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;analysis&quot;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">image_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;heatmap&quot;</span><span class="p">,</span> <span class="s2">&quot;emotion_chart&quot;</span><span class="p">,</span> <span class="s2">&quot;polarity_chart&quot;</span><span class="p">,</span> <span class="s2">&quot;radar_chart&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid image type&quot;</span><span class="p">)</span>
    
    <span class="c1"># Extract the image data</span>
    <span class="k">if</span> <span class="n">image_type</span> <span class="ow">in</span> <span class="n">analysis</span> <span class="ow">and</span> <span class="n">analysis</span><span class="p">[</span><span class="n">image_type</span><span class="p">]:</span>
        <span class="c1"># Extract base64 image data</span>
        <span class="n">img_data</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="n">image_type</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">img_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span>
        
        <span class="c1"># Return the image</span>
        <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_bytes</span><span class="p">),</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;image/png&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Image not found&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="process_query_background">
<a class="viewcode-back" href="../modules.html#server.process_query_background">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_query_background</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">question_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ethical_views</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes a query asynchronously in the background, updating job status and progress,</span>
<span class="sd">    interacting with agents, aggregating responses, and saving results to the database.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        job_id (str): A unique identifier for the job being processed.</span>
<span class="sd">        query (str): The query string to be processed.</span>
<span class="sd">        question_type (str): The type of question being asked (e.g., factual, analytical).</span>
<span class="sd">        domain (str): The domain or context of the query.</span>
<span class="sd">        ethical_views (List[str]): A list of ethical perspectives.</span>
<span class="sd">        username (str): The username of the user submitting the query.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        Exception: Captures and logs any errors that occur during processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Update job status</span>
        <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;processing&quot;</span><span class="p">,</span>
            <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>

        <span class="c1"># Update progress</span>
        <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="s2">&quot;progress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="c1"># Update all agent heartbeats before processing</span>
        <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">update_agent_heartbeat</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
        
        <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="s2">&quot;progress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

        <span class="c1"># Process the query</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response_aggregator</span><span class="o">.</span><span class="n">process_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">question_type</span><span class="p">)</span>
        
        <span class="c1"># Update all agent heartbeats after processing</span>
        <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">update_agent_heartbeat</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>

        <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="s2">&quot;progress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span>

        <span class="c1"># Update progress</span>
        <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="s2">&quot;progress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">90</span>
        
        <span class="c1"># Extract model responses</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">]</span>
        <span class="n">aggregator_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aggregator_id&quot;</span><span class="p">)</span>

        <span class="n">agg_response</span> <span class="o">=</span> <span class="n">responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aggregator_id</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">agg_response</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">agg_response</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;could not generate&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="s2">&quot;all models failed&quot;</span> <span class="ow">in</span> <span class="n">agg_response</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aggregator failed. Skipping DB save for job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Aggregator did not produce a valid response.&quot;</span>
            <span class="p">}</span>
            <span class="k">return</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;analysis&quot;</span><span class="p">]</span>
        
        <span class="c1"># Get aggregator and non-aggregator models</span>
        <span class="n">non_aggregator_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_id</span> <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aggregator&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>
        
        <span class="c1"># Construct result dictionary</span>
        <span class="n">model_responses</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">model_id</span><span class="p">:</span> <span class="n">responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="s2">&quot;Error: Model failed to respond&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span> 

        <span class="c1"># Construct roles string, skip models with error responses</span>
        <span class="n">roles_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Assign roles only once for all agent_ids</span>
        <span class="n">agent_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">mid</span> <span class="k">for</span> <span class="n">mid</span> <span class="ow">in</span> <span class="n">responses</span> <span class="k">if</span> <span class="n">mid</span> <span class="o">!=</span> <span class="n">aggregator_id</span><span class="p">]</span>
        <span class="n">ethics_map</span> <span class="o">=</span> <span class="n">assign_ethics_to_agents</span><span class="p">(</span><span class="n">agent_ids</span><span class="p">,</span> <span class="n">ethical_views</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">model_id</span> <span class="o">==</span> <span class="n">aggregator_id</span><span class="p">:</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="s2">&quot;Aggregator&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Use precomputed map</span>
                    <span class="n">role_full</span> <span class="o">=</span> <span class="n">ethics_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ETHICAL_VIEWS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">role_full</span><span class="p">]</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="n">role</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">role</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

                    <span class="k">if</span> <span class="n">role</span><span class="p">:</span>
                        <span class="n">role</span> <span class="o">=</span> <span class="n">role</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Optional: shorten long ethics description</span>
                <span class="k">if</span> <span class="n">role</span><span class="p">:</span>
                    <span class="n">roles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">roles_str</span> <span class="o">=</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roles_list</span><span class="p">)</span>

        <span class="c1"># All models succeeded, safe to save</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">save_responses</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">model_responses</span><span class="p">,</span> <span class="n">aggregator_id</span><span class="p">)</span>
        <span class="c1"># Save the interaction to database</span>
        <span class="n">db_manager</span><span class="o">.</span><span class="n">save_interaction</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">question_type</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">roles_str</span><span class="p">)</span>
        
        <span class="c1"># Calculate and save analysis</span>
        <span class="n">consensus_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">:</span>
            <span class="n">consensus_score</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;consensus_score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">db_manager</span><span class="o">.</span><span class="n">save_analysis</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">consensus_score</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">analysis</span><span class="p">)</span>

        <span class="c1"># Update job status to completed</span>
        <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="n">model_responses</span><span class="p">,</span>
                <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">,</span>
                <span class="s2">&quot;consensus_score&quot;</span><span class="p">:</span> <span class="n">consensus_score</span><span class="p">,</span>
                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
                <span class="s2">&quot;question_type&quot;</span><span class="p">:</span> <span class="n">question_type</span><span class="p">,</span>
                <span class="s2">&quot;aggregator_id&quot;</span><span class="p">:</span> <span class="n">aggregator_id</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing query: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">active_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">}</span></div>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/models&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_get_models</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches the list of available models and their metadata.</span>

<span class="sd">    This asynchronous function retrieves information about all available models,</span>
<span class="sd">    including their name, whether they use an aggregator, their associated color,</span>
<span class="sd">    and a formatted display name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary where each key is a model ID and the value is another</span>
<span class="sd">        dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">MODELS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">model_info</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="s2">&quot;aggregator&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aggregator&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">MODEL_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="s2">&quot;#95a5a6&quot;</span><span class="p">),</span>
            <span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="n">format_model_name</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">model_info</span>

<div class="viewcode-block" id="format_model_name">
<a class="viewcode-back" href="../modules.html#server.format_model_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_model_name</span><span class="p">(</span><span class="n">model_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Formats the model name based on its configuration.</span>
<span class="sd">    This function retrieves the model configuration using the provided `model_id`</span>
<span class="sd">    from the `MODELS` dictionary. It extracts the model name from the path, removes</span>
<span class="sd">    unnecessary formatting (e.g., version numbers and suffixes like &quot;-instruct&quot;),</span>
<span class="sd">    capitalizes each word, and appends an &quot;Aggregator&quot; tag if applicable.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        model_id (str): The identifier for the model in the `MODELS` dictionary.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: A human-readable, formatted model name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">MODELS</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="c1"># Extract model name from path and make it pretty</span>
    <span class="n">display_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Remove version numbers and formatting like &quot;-instruct&quot;</span>
    <span class="n">display_name</span> <span class="o">=</span> <span class="n">display_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-instruct&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># Capitalize words</span>
    <span class="n">formatted_name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">display_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
    
    <span class="c1"># Add aggregator tag if applicable</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aggregator&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">formatted_name</span> <span class="o">+=</span> <span class="s2">&quot; (Aggregator)&quot;</span>
    
    <span class="k">return</span> <span class="n">formatted_name</span></div>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/domains&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_get_domains</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronous function to retrieve a list of domains.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the key &quot;domains&quot; mapped to the value of the global variable `DOMAINS`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;domains&quot;</span><span class="p">:</span> <span class="n">DOMAINS</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/question_types&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_get_question_types</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronous function to retrieve available question types.</span>

<span class="sd">    This function returns a dictionary containing a list of question types</span>
<span class="sd">    derived from the keys of the `QUESTION_PREFIXES` dictionary, along with</span>
<span class="sd">    an additional &quot;None&quot; option.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary with a single key &quot;question_types&quot;, whose value</span>
<span class="sd">        is a list of available question types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;question_types&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">QUESTION_PREFIXES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">]}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/examples&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_get_examples</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronous function to retrieve example data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing examples categorized by domain.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;examples&quot;</span><span class="p">:</span> <span class="n">EXAMPLES_BY_DOMAIN</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/agent_health&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_agent_health</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously checks the health of agents and formats the health status response.</span>
<span class="sd">    This function calls `check_agent_health()` to update the health status of agents.</span>
<span class="sd">    It then processes the `agent_health` dictionary to create a formatted response</span>
<span class="sd">    containing the health status of each agent, including the time since the last</span>
<span class="sd">    heartbeat, the number of failures, and retries.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary where each key is a model ID and the value is another</span>
<span class="sd">        dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">check_agent_health</span><span class="p">()</span>
    
    <span class="c1"># Format the response</span>
    <span class="n">health_status</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">health</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">last_heartbeat_str</span> <span class="o">=</span> <span class="n">health</span><span class="p">[</span><span class="s2">&quot;last_heartbeat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">time_since</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">health</span><span class="p">[</span><span class="s2">&quot;last_heartbeat&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        
        <span class="n">health_status</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">health</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">],</span>
            <span class="s2">&quot;last_heartbeat&quot;</span><span class="p">:</span> <span class="n">last_heartbeat_str</span><span class="p">,</span>
            <span class="s2">&quot;seconds_since_heartbeat&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">time_since</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;failures&quot;</span><span class="p">:</span> <span class="n">health</span><span class="p">[</span><span class="s2">&quot;failures&quot;</span><span class="p">],</span>
            <span class="s2">&quot;retries&quot;</span><span class="p">:</span> <span class="n">health</span><span class="p">[</span><span class="s2">&quot;retries&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">health_status</span>

<span class="c1"># Add reset endpoint</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/reset_agent/</span><span class="si">{model_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_reset_agent</span><span class="p">(</span><span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the API request to reset a specific agent by its model ID.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        model_id (str): The unique identifier of the agent to be reset.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: If the specified agent is not found in the system.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the status and a success message indicating</span>
<span class="sd">              that the agent has been reset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent_health</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Agent not found&quot;</span><span class="p">)</span>
    
    <span class="k">await</span> <span class="n">reset_failed_agent</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> has been reset&quot;</span><span class="p">}</span>

<span class="c1"># Main entry point</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
    
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Multi-Agent LLM Backend Server&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--host&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Host to run the server on&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Port to run the server on&quot;</span><span class="p">)</span>
    
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="c1"># Create .env template</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;.env&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;.env&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;# OpenRouter API Configuration</span>
<span class="s2">OPENROUTER_API_KEY=</span>
<span class="s2">SITE_URL=http://localhost:7860</span>
<span class="s2">SITE_NAME=Multi-Agent LLM System</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
    
    <span class="c1"># Log startup</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting server on </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Run the server</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Manasvi Goyal and Sukanya Krishna.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>